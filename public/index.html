<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åœ†æ¡Œä¼šè®®</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        min-height: 100vh;
        padding: 20px;
      }
      #sendButton {
        background-color: #007bff;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }
      .header {
        color: #000;
        padding: 20px;
        text-align: center;
      }
      .header h1 {
        font-size: 1.8em;
        margin-bottom: 5px;
      }
      .status-bar {
        background: #f8f9fa;
        padding: 12px 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
        color: #666;
      }
      .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .connected {
        background: #28a745;
      }
      .disconnected {
        background: #dc3545;
      }
      .chat-area {
        display: flex;
        flex-direction: column;
        height: 500px;
      }
      .messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message.system {
        background: #e9ecef;
        color: #495057;
        text-align: center;
        margin: 10px auto;
        max-width: 90%;
        font-size: 0.9em;
        border-radius: 10px;
      }
      .message.own {
        background: #007bff;
        color: white;
        margin-left: auto;
      }
      .message.other {
        background: white;
        color: #333;
        border: 1px solid #dee2e6;
        margin-right: auto;
      }
      .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.8em;
        opacity: 0.8;
      }
      .input-area {
        padding: 15px 20px;
        border-top: 1px solid #dee2e6;
        background: white;
        display: flex;
        gap: 10px;
      }
      .input-area input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 1em;
        outline: none;
        transition: border-color 0.2s;
      }
      .input-area input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      }
      .input-area button {
        padding: 12px 25px;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        transition: transform 0.2s, opacity 0.2s;
      }
      .input-area button:hover {
        transform: translateY(-2px);
        opacity: 0.9;
      }
      .input-area button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .typing-indicator {
        padding: 5px 20px;
        color: #6c757d;
        font-style: italic;
        font-size: 0.9em;
        min-height: 24px;
      }
      .user-info {
        padding: 15px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
      }
      .user-info input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 1em;
        margin-top: 10px;
      }
      .info-panel {
        padding: 15px 20px;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        font-size: 0.9em;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>åœ†æ¡Œä¼šè®®å®¤</h1>
      </div>

      <div class="status-bar">
        <div>
          <span id="statusDot" class="status-dot disconnected"></span>
          <span id="statusText">æ­£åœ¨è¿æ¥...</span>
        </div>
        <div>
          åœ¨çº¿: <span id="onlineCount">0</span> äºº | ç”¨æˆ·ID:
          <span id="userId">-</span>
        </div>
      </div>

      <div class="user-info">
        <div>ä½ çš„æ˜µç§°: <span id="currentUsername">-</span></div>
        <input
          type="text"
          id="usernameInput"
          placeholder="è¾“å…¥æ˜µç§° (é»˜è®¤ä½¿ç”¨éšæœºåç§°)"
          onchange="updateUsername()"
        />
      </div>

      <div class="chat-area">
        <div class="messages" id="messagesContainer">
          <!-- æ¶ˆæ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        <div class="typing-indicator" id="typingIndicator"></div>
      </div>

      <div class="input-area">
        <input
          type="text"
          id="messageInput"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          oninput="sendTypingIndicator()"
          onkeypress="handleKeyPress(event)"
        />
        <button id="sendButton" onclick="sendMessage()" disabled>å‘é€</button>
      </div>

      <div class="info-panel">
        <div>ğŸ’¡ æç¤º: åœ¨åŒä¸€å±€åŸŸç½‘ä¸‹çš„å…¶ä»–è®¾å¤‡è®¿é—®æ­¤æœåŠ¡å™¨IPå³å¯åŠ å…¥èŠå¤©</div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let ws = null;
      let userId = "";
      let username = "";
      let typingTimeout = null;

      // éšæœºç”Ÿæˆæ˜µç§°
      function generateUsername() {
        const adjectives = [
          "å¿«ä¹çš„",
          "èªæ˜çš„",
          "å¥½å¥‡çš„",
          "å®‰é™çš„",
          "æ´»æ³¼çš„",
          "å‹¤å¥‹çš„",
        ];
        const nouns = ["å°çŒ«", "å°ç‹—", "ç†ŠçŒ«", "å…”å­", "æ¾é¼ ", "å°é¸Ÿ"];
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        return adj + noun;
      }

      // è¿æ¥WebSocket
      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}`;

        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          updateStatus("å·²è¿æ¥", true);
          document.getElementById("sendButton").disabled = false;
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleWebSocketMessage(data);
        };

        ws.onclose = () => {
          updateStatus("å·²æ–­å¼€", false);
          document.getElementById("sendButton").disabled = true;
          // 3ç§’åé‡è¿
          setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = (error) => {
          console.error("WebSocketé”™è¯¯:", error);
          updateStatus("è¿æ¥é”™è¯¯", false);
        };
      }

      // å¤„ç†WebSocketæ¶ˆæ¯
      function handleWebSocketMessage(data) {
        switch (data.type) {
          case "welcome":
            userId = data.userId;
            username = generateUsername();
            document.getElementById("userId").textContent = userId.substring(
              0,
              8
            );
            document.getElementById("currentUsername").textContent = username;
            document.getElementById("usernameInput").value = username;
            document.getElementById("onlineCount").textContent =
              data.onlineCount;

            // æ˜¾ç¤ºå†å²æ¶ˆæ¯
            if (data.messageHistory) {
              data.messageHistory.forEach((msg) => addMessageToChat(msg));
            }
            break;

          case "chat_message":
            addMessageToChat(data);
            break;

          case "user_joined":
            addSystemMessage(`ğŸ‘¤ ${data.userId.substring(0, 8)} åŠ å…¥äº†èŠå¤©`);
            document.getElementById("onlineCount").textContent =
              data.onlineCount;
            break;

          case "user_left":
            addSystemMessage(`ğŸ‘¤ ${data.userId.substring(0, 8)} ç¦»å¼€äº†èŠå¤©`);
            document.getElementById("onlineCount").textContent =
              data.onlineCount;
            break;

          case "typing":
            showTypingIndicator(data.username);
            break;

          case "user_update":
            // ç”¨æˆ·ä¿¡æ¯æ›´æ–°ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†
            break;
        }
      }

      // å‘é€æ¶ˆæ¯
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const content = input.value.trim();

        if (content && ws && ws.readyState === WebSocket.OPEN) {
          const message = {
            type: "chat_message",
            content: content,
            username: username,
          };

          ws.send(JSON.stringify(message));
          input.value = "";

          // æ¸…ç©ºè¾“å…¥æŒ‡ç¤º
          document.getElementById("typingIndicator").textContent = "";
        }
      }

      // å‘é€"æ­£åœ¨è¾“å…¥"æŒ‡ç¤º
      function sendTypingIndicator() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "typing",
              username: username,
            })
          );

          // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
          if (typingTimeout) clearTimeout(typingTimeout);

          // 2ç§’ååœæ­¢æ˜¾ç¤ºè¾“å…¥çŠ¶æ€
          typingTimeout = setTimeout(() => {
            document.getElementById("typingIndicator").textContent = "";
          }, 2000);
        }
      }

      // æ›´æ–°ç”¨æˆ·å
      function updateUsername() {
        const newUsername = document
          .getElementById("usernameInput")
          .value.trim();
        if (newUsername && newUsername !== username) {
          username = newUsername;
          document.getElementById("currentUsername").textContent = username;

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: "user_update",
                username: username,
              })
            );
          }
          addSystemMessage(`ğŸ˜ä½ çš„æ˜µç§°å·²æ›´æ–°ä¸º: ${username}`);
        }
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
      function addMessageToChat(message) {
        const container = document.getElementById("messagesContainer");
        const messageDiv = document.createElement("div");

        const isOwnMessage = message.userId === userId;
        const isSystem = message.type === "system_message";

        if (isSystem) {
          messageDiv.className = "message system";
          messageDiv.textContent = message.content;
        } else {
          messageDiv.className = `message ${isOwnMessage ? "own" : "other"}`;

          const time = new Date(message.timestamp).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          messageDiv.innerHTML = `
                    <div class="message-header">
                        <span>${message.username || "åŒ¿åç”¨æˆ·"}</span>
                        <span>${time}</span>
                    </div>
                    <div>${escapeHtml(message.content)}</div>
                `;
        }

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }

      // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
      function addSystemMessage(content) {
        addMessageToChat({
          type: "system_message",
          content: content,
          timestamp: new Date().toISOString(),
        });
      }

      // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"æŒ‡ç¤º
      function showTypingIndicator(typingUsername) {
        const indicator = document.getElementById("typingIndicator");
        if (typingUsername !== username) {
          indicator.textContent = `${typingUsername} æ­£åœ¨è¾“å…¥...`;
        }
      }

      // æ›´æ–°è¿æ¥çŠ¶æ€
      function updateStatus(text, isConnected) {
        const dot = document.getElementById("statusDot");
        const textElem = document.getElementById("statusText");

        dot.className = `status-dot ${
          isConnected ? "connected" : "disconnected"
        }`;
        textElem.textContent = text;
      }

      // å¤„ç†æŒ‰é”®äº‹ä»¶
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendMessage();
        }
      }

      // HTMLè½¬ä¹‰
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // é¡µé¢åŠ è½½æ—¶è¿æ¥WebSocket
      window.onload = connectWebSocket;
    </script>
  </body>
</html>
